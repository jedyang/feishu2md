# GitLab CI/CD configuration for feishu2md project

stages:
  - test
  - build
  - deploy

variables:
  # Harbor repository settings
  HARBOR_REGISTRY: your-harbor-registry.example.com  # 替换为你的Harbor仓库地址
  HARBOR_PROJECT: your-project  # 替换为你的Harbor项目名称
  IMAGE_NAME: feishu2md
  IMAGE_TAG: ${CI_COMMIT_SHORT_SHA}
  FULL_IMAGE_NAME: ${HARBOR_REGISTRY}/${HARBOR_PROJECT}/${IMAGE_NAME}:${IMAGE_TAG}
# Run tests
test:
  stage: test
  image: golang:1.24-alpine
  script:
    - go mod download
    - go test ./...
  only:
    - branches

# Build Docker image
build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  script:
    - docker build -t ${FULL_IMAGE_NAME} .
  only:
    - branches
  artifacts:
    paths:
      - ./feishu2md4web
    expire_in: 1 week

# Push to Harbor registry
deploy:
  stage: deploy
  image: docker:latest
  services:
    - docker:dind
  script:
    - echo "Logging in to Harbor registry..."
    - docker login -u ${HARBOR_USER} -p ${HARBOR_PASSWORD} ${HARBOR_REGISTRY}
    - echo "Pushing image to Harbor..."
    - docker push ${FULL_IMAGE_NAME}
    - echo "Deployment completed successfully!"
  only:
    - main  # 只在main分支上部署
  environment:
    name: production
  variables:
    GIN_MODE: release
